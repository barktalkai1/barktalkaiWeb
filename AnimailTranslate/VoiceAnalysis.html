<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>
        Animal Translate AI Agent
    </title>
    
    <!-- MDB icon -->
    <link rel="icon" href="img/mdb-favicon.ico" type="image/x-icon" />
    <!-- Font Awesome -->
    <link href="all.min.css" rel="stylesheet" />
    <!-- Google Fonts Roboto -->
    <link href="css2.css" rel="stylesheet" />
    <!-- MDB CSS -->
    <link href="mdb.min.css" rel="stylesheet" />
    <!-- MDB JS -->
    <script src="mdb.min.js"></script>
    <!-- ethersé’±åŒ… -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <style>
        #chat2 .form-control {
            border-color: transparent;
        }

            #chat2 .form-control:focus {
                border-color: transparent;
                box-shadow: inset 0px 0px 0px 1px transparent;
            }

        .divider:after,
        .divider:before {
            content: "";
            flex: 1;
            height: 1px;
            background: #eee;
        }

        /* ä¸‰è§’å½¢å’Œæ–‡å­—å®¹å™¨ */
        .tooltip-triangle {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10;
        }

            /* æç¤ºæ–‡å­— */
            .tooltip-triangle .tooltip-text {
                margin-bottom: 5px; /* æ–‡å­—åœ¨ä¸Šæ–¹ */
                font-size: 12px;
                color: #333;
                background-color: #f8f9fa;
                border: 1px solid #ddd;
                padding: 2px 5px;
                border-radius: 4px;
                white-space: nowrap;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            /* ä¸‹æ–¹çš„ä¸‰è§’å½¢ */
            .tooltip-triangle .triangle {
                width: 0;
                height: 0;
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                border-top: 10px solid #333; /* æ”¹ä¸ºå‘ä¸Šçš„ä¸‰è§’å½¢ */
            }

        /* éŸ³é‡æ¡ */
        #volumeBar {
            display: none; /* é»˜è®¤éšè—ï¼Œå½•éŸ³æ—¶æ˜¾ç¤º */
        }



        .tooltip-triangle {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>



</head>
<body>
    <!-- Start your project here-->
    <section>
        <div class="container py-5">

            <div class="row d-flex justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-6">

                    <div class="card" id="chat2">
                        <div class="card-header d-flex justify-content-between align-items-center p-3">
                            <h5 class="mb-0">Animal Translate</h5>
                            <!-- Connect Wallet æŒ‰é’® -->
                            <button type="button" class="btn btn-dark btn-sm" id="walletButton">
                                Connect Wallet
                            </button>

                            <!-- æ¨¡æ€æ¡† -->
                            <!-- æ¨¡æ€æ¡† -->
                            <div class="modal fade"
                                 id="walletModal"
                                 tabindex="-1"
                                 aria-labelledby="walletModalLabel"
                                 aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content" style="height: 391px;">
                                        <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="walletModalLabel">Log in or sign up</h5>
                                            <button type="button"
                                                    class="btn-close"
                                                    data-mdb-dismiss="modal"
                                                    aria-label="Close"></button>
                                        </div>

                                        <!-- æ¨¡æ€æ¡†ä¸»ä½“å†…å®¹ -->
                                        <div class="modal-body text-center">
                                            <!-- Logo -->
                                            <img src="kh5ynoMH_400x400.jpg"
                                                 alt="Virtual Protocol App logo"
                                                 style="max-height: 90px; max-width: 180px;"
                                                 class="mb-3" />



                                            <!-- é’±åŒ…ç™»å½• (MetaMask) -->
                                            <button class="btn btn-secondary w-100 d-flex align-items-center justify-content-center" id="connectWalletButton">
                                                <img src="metamask.png"
                                                     alt="MetaMask Logo"
                                                     style="width: 24px; height: 24px; margin-right: 8px;">
                                                Continue with MetaMask
                                            </button>


                                            <!-- é’±åŒ…åœ°å€ (ç™»å½•æˆåŠŸåæ˜¾ç¤º) -->
                                            <p id="walletAddressDisplay" class="mt-3 text-muted" style="display: none;"></p>
                                        </div>

                                        <!-- æ¨¡æ€æ¡†åº•éƒ¨ -->
                                        <div class="modal-footer">
                                            <a href="https://www.privy.io/"
                                               target="_blank"
                                               class="text-muted small">Powered by MetaMask</a>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                        <div class="card-body" data-mdb-perfect-scrollbar-init style="position: relative; height: 400px; overflow-y: auto;">


                        </div>
                        <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3 position-relative">
                            <!-- éŸ³é‡æ¡å®¹å™¨ -->
                            <div id="volumeBar" class="position-absolute" style="bottom: 60px; left: 50%; transform: translateX(-50%); width: 200px; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; display: none;">
                                <div id="volumeLevel" style="height: 100%; width: 0; background-color: #007bff;"></div>
                            </div>

                            <!-- æç¤ºä¸‰è§’å½¢ -->
                            <div class="tooltip-triangle position-absolute" style="top: -20px; left: 0;">
                                <div class="triangle"></div>
                                <span class="tooltip-text">ç‚¹å‡»åˆ‡æ¢</span>
                            </div>

                            <!-- å¤´åƒå›¾ç‰‡ -->
                            <img src="ava3-bg.png"
                                 alt="avatar 3"
                                 id="avatarImage"
                                 style="width: 40px; height: 100%; cursor: pointer;" />

                            <!-- å½•éŸ³æŒ‰é’® -->
                            <button type="button" class="btn btn-primary btn-lg w-100 ms-3" id="sendButton">Push To Talk</button>

                            <!-- å¥—é¤ä¿¡æ¯ï¼ˆå‰©ä½™æ—¶é—´ï¼‰ -->
                            <div id="planInfo" class="ms-3 text-primary fw-semibold"></div>

                        </div>


                    </div>

                </div>
            </div>

        </div>
    </section>
    <!-- End your project here-->
    <!-- Custom scripts -->
    <!-- Jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript">
        // è·å– URL å‚æ•°
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // è·å– wallet å’Œ amount
        const walletAddress = getQueryParam("wallet");
        const amount = getQueryParam("amount");

        if (walletAddress) {
            // æ ¼å¼åŒ–é’±åŒ…åœ°å€
            const shortAddress = `${walletAddress.substring(0, 6)}...${walletAddress.substring(walletAddress.length - 4)}`;

            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            const walletButton = document.getElementById('walletButton');
            walletButton.innerText = "Connect " + shortAddress;

            // å‘é€ AJAX è¯·æ±‚è·å–ç”¨æˆ·å¥—é¤ä¿¡æ¯
            let formData = new FormData();
            formData.append("act", "GetUserPlan");
            formData.append("wallet", walletAddress);
            fetch("ajax/ajax.ashx", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    let planInfoElement = document.getElementById("planInfo");

                    if (data.success) {
                        planInfoElement.innerText = `Remaining : ${data.remainingTime} Min`;
                    } else {
                        planInfoElement.innerText = "No Active Plan";
                        planInfoElement.style.color = "red"; // å¤±è´¥æ—¶æ˜¾ç¤ºçº¢è‰²
                    }
                })
                .catch(error => {
                    console.error("âŒ è¯·æ±‚é”™è¯¯:", error);
                    document.getElementById("planInfo").innerText = "Error Loading Plan";
                });
        }
        else {
            // å¼¹çª—æç¤ºå¹¶è·³è½¬åˆ° welcome.html
            alert("No address found. Redirecting to the welcome page...");
            window.location.href = "welcome.html";
        }

        // **ğŸ”¹ è®¡ç®—å¹¶æ›´æ–°æ•°æ®åº“ä¸­çš„å‰©ä½™åˆ†é’Ÿæ•°**
        if (walletAddress && amount) {
            let additionalMinutes = 0;

            if (amount == "100") {
                additionalMinutes = 60;  // å¥—é¤A
            } else if (amount == "800") {
                additionalMinutes = 600; // å¥—é¤B
            } else if (amount == "1800") {
                additionalMinutes = 1440; // å¥—é¤C
            }

            // å‘é€è¯·æ±‚åˆ°åç«¯ï¼Œæ›´æ–°æ•°æ®åº“
            let updateFormData = new FormData();
            updateFormData.append("act", "UpdateUserPlan");
            updateFormData.append("wallet", walletAddress);
            updateFormData.append("minutes", additionalMinutes);

            fetch("ajax/ajax.ashx", {
                method: "POST",
                body: updateFormData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ˜¾ç¤ºæ–°çš„å‰©ä½™æ—¶é—´
                        document.getElementById("planInfo").innerText = `Remaining : ${data.remainingTime} Min`;
                        // **å»é™¤ URL ä¸­çš„ amount å‚æ•°**
                        const url = new URL(window.location.href);
                        url.searchParams.delete("amount"); // ç§»é™¤å‚æ•°
                        window.history.replaceState({}, document.title, url.toString()); // æ›¿æ¢ URLï¼Œä¸åˆ·æ–°é¡µé¢
                    } else {
                        console.log("âŒ å¥—é¤æ›´æ–°å¤±è´¥:", data.message);
                    }
                })
                .catch(error => console.error("âŒ æ›´æ–°å¥—é¤è¯·æ±‚é”™è¯¯:", error));
        }


        // è·å–å¤´åƒå›¾ç‰‡å…ƒç´ 
        const avatarImage = document.getElementById('avatarImage');

        // å®šä¹‰ä¸¤ä¸ªå¤´åƒå›¾ç‰‡çš„è·¯å¾„
        const avatar1 = 'ava3-bg.png';
        const avatar2 = 'doglog.png';

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        avatarImage.addEventListener('click', () => {
            // åˆ‡æ¢å›¾ç‰‡è·¯å¾„
            avatarImage.src = avatarImage.src.includes('ava3-bg.png') ? avatar2 : avatar1;
        });

        const tooltip = document.querySelector('.tooltip-triangle');
        avatarImage.addEventListener('click', () => {

            tooltip.style.display = 'none'; // ç‚¹å‡»åéšè—æç¤º
        });

        // è·å–é¡µé¢å…ƒç´ 
        const sendButton = document.getElementById('sendButton');
        const volumeBar = document.getElementById('volumeBar');
        const volumeLevel = document.getElementById('volumeLevel');

        // å®šä¹‰å…¨å±€å˜é‡
        let mediaRecorder = null;
        let audioChunks = [];
        let microphoneStream = null;
        let audioContext = null;
        let analyser = null;
        let dataArray = null;

        // æŒ‰ä½æŒ‰é’®æ—¶å¼€å§‹å½•éŸ³
        sendButton.addEventListener('mousedown', async () => {
            volumeBar.style.display = 'block'; // æ˜¾ç¤ºéŸ³é‡æ¡
            $("#sendButton").text("Recording...");
            try {
                // è·å–éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphoneStream = stream;

                // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡å’Œåˆ†æå™¨ï¼ˆç”¨äºæ˜¾ç¤ºéŸ³é‡ï¼Œå¯é€‰ï¼‰
                audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                source.connect(analyser);

                // å®æ—¶æ›´æ–°éŸ³é‡æ˜¾ç¤º
                const updateVolume = () => {
                    analyser.getByteFrequencyData(dataArray);
                    const volume = Math.max(...dataArray) / 256;  // è·å–éŸ³é‡å€¼ï¼ˆ0~1ï¼‰
                    volumeLevel.style.width = `${volume * 100}%`;
                    if (microphoneStream.active) {
                        requestAnimationFrame(updateVolume);
                    }
                };
                updateVolume();

                // åˆå§‹åŒ– MediaRecorder
                // å°è¯•ä½¿ç”¨æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹ï¼ˆå¦‚ audio/webmï¼‰
                if (MediaRecorder.isTypeSupported('audio/webm')) {
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                } else {
                    mediaRecorder = new MediaRecorder(stream);
                }

                // æ¸…ç©ºä¸Šæ¬¡å½•éŸ³æ•°æ®
                audioChunks = [];

                // ç»‘å®š ondataavailable äº‹ä»¶ï¼šå½•éŸ³æ•°æ®å—åˆ°è¾¾æ—¶ä¿å­˜åˆ°æ•°ç»„ä¸­
                mediaRecorder.ondataavailable = (event) => {
                    console.log("æ”¶åˆ°æ•°æ®å—ï¼Œå¤§å°ï¼š", event.data.size);
                    if (event.data && event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                // å½“å½•éŸ³åœæ­¢åï¼Œå¤„ç†å¹¶ä¸Šä¼ å½•éŸ³æ•°æ®
                mediaRecorder.onstop = async () => {
                    //ç¦ç”¨å½•éŸ³æŒ‰é’®
                    $("#sendButton").prop("disabled", true);
                    $("#sendButton").text("Analyze...Please Wait");
                    console.log("å½•éŸ³åœæ­¢ï¼Œæ•°æ®å—æ•°é‡ï¼š", audioChunks.length);
                    // ä½¿ç”¨æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹åˆ›å»º Blob å¯¹è±¡
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    console.log("ç”Ÿæˆçš„ Blob å¤§å°:", audioBlob.size);

                    // åˆ›å»º File å¯¹è±¡ï¼ˆå¯é€‰ï¼Œæ ¹æ®åç«¯è¦æ±‚ï¼‰
                    const audioFile = new File([audioBlob], 'recording.webm', { type: 'audio/webm' });

                    // åˆ›å»º FormDataï¼Œå¹¶æ·»åŠ æ–‡ä»¶å’Œ act å‚æ•°
                    const formData = new FormData();
                    formData.append('audio', audioFile);
                    formData.append('act', 'AnalysisRecord');

                    try {
                        // å‘é€ POST è¯·æ±‚åˆ°æœåŠ¡å™¨
                        const response = await fetch('/ajax/ajax.ashx', {
                            method: 'POST',
                            body: formData,
                        });
                        if (!response.ok) {
                            const errText = await response.text();
                            console.error("æœåŠ¡å™¨è¿”å›é”™è¯¯ä»£ç :", response.status, errText);
                            alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                            return;
                        }
                        const result = await response.json();
                        //alert(`å½•éŸ³å·²å‘é€ï¼æœåŠ¡å™¨è¿”å›: ${result.message}æ–‡ä»¶å: ${result.fileName}`);
                        // åŠ¨æ€åˆ›å»ºHTMLå†…å®¹
                        //const ChatContent = `
                        //<div class="d-flex flex-row justify-content-end mb-4">
                        // <div>
                        //     <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">
                        //       éŸ³é«˜ï¼š${result.hzvalue},æƒ…ç»ªåˆ†ï¼š${result.emotionScore},AIæ¨¡å‹è¿”å›ï¼š${result.DogMessage}
                        //     </p>
                        // </div>
                        // <img src="doglog.png"
                        //      alt="avatar 1" style="width: 45px; height: 100%;">
                        //</div>`;
                        const ChatContent = `
                                  <div class="d-flex flex-row justify-content-end mb-4">
                                   <div>
                                       <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">
                                         ${result.DogMessage}
                                       </p>
                                   </div>
                                   <img src="doglog.png"
                                        alt="avatar 1" style="width: 45px; height: 100%;">
                                  </div>`;
                        // å°†å†…å®¹è¿½åŠ åˆ°èŠå¤©æ¡†ä¸­
                        $(".card-body").append(ChatContent);
                        //å¯ç”¨å½•éŸ³æŒ‰é’®
                        $("#sendButton").prop("disabled", false);
                        //ä¿®æ”¹æŒ‰é’®å†…å®¹
                        $("#sendButton").text("PUSH TO TALK");

                    } catch (error) {
                        console.error('ä¸Šä¼ é”™è¯¯:', error);
                        alert('ä¸Šä¼ é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼');
                    }

                    // å½•éŸ³æ•°æ®ä¸Šä¼ å®Œæ¯•åï¼Œå…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼Œå¹¶éšè—éŸ³é‡æ¡
                    if (audioContext) {
                        audioContext.close();
                    }
                    volumeBar.style.display = 'none';
                };

                // å¼€å§‹å½•éŸ³
                mediaRecorder.start();
                console.log("å½•éŸ³å¼€å§‹");
            } catch (err) {
                console.error("è·å–éº¦å…‹é£æƒé™å¤±è´¥ï¼š", err);
                alert("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®ï¼");
            }
        });

        // æ¾å¼€æŒ‰é’®æ—¶åœæ­¢å½•éŸ³
        sendButton.addEventListener('mouseup', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (microphoneStream) {
                microphoneStream.getTracks().forEach(track => track.stop());
            }
        });



    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let walletAddress = getQueryParam("wallet"); // è·å–URLä¸­çš„é’±åŒ…åœ°å€

            if (!walletAddress) {
                alert("âŒ No wallet address found.");
                window.location.href = "welcome.html"; // æ²¡æœ‰é’±åŒ…åœ°å€æ—¶ï¼Œè·³è½¬å›é¦–é¡µ
                return;
            }

            // æ ¼å¼åŒ–é’±åŒ…åœ°å€
            const shortAddress = `${walletAddress.substring(0, 6)}...${walletAddress.substring(walletAddress.length - 4)}`;
            document.getElementById("walletButton").innerText = "Connect " + shortAddress;

            // ç«‹å³æŸ¥è¯¢ä¸€æ¬¡ç”¨æˆ·å‰©ä½™æ—¶é—´
            updateUserRemainingTime(walletAddress);

            // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯ 60 ç§’æ‰£é™¤ 1 åˆ†é’Ÿ
            setInterval(() => {
                deductUserTime(walletAddress);
            }, 60000);
        });

        // è·å– URL å‚æ•°
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // æ›´æ–°ç”¨æˆ·å¥—é¤ä¿¡æ¯
        function updateUserRemainingTime(wallet) {
            let formData = new FormData();
            formData.append("act", "GetUserPlan");
            formData.append("wallet", wallet);

            fetch("ajax/ajax.ashx", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    let planInfoElement = document.getElementById("planInfo");
                    if (data.success) {
                        planInfoElement.innerText = `Remaining : ${data.remainingTime} Min`;
                    } else {
                        planInfoElement.innerText = "No Active Plan";
                        planInfoElement.style.color = "red";
                    }
                })
                .catch(error => {
                    console.error("âŒ è¯·æ±‚é”™è¯¯:", error);
                    document.getElementById("planInfo").innerText = "Error Loading Plan";
                });
        }

        // æ¯åˆ†é’Ÿæ‰£é™¤ 1 åˆ†é’Ÿæ—¶é—´
        function deductUserTime(wallet) {
            let formData = new FormData();
            formData.append("act", "DeductTime");
            formData.append("wallet", wallet);

            fetch("ajax/ajax.ashx", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("planInfo").innerText = `Remaining : ${data.remainingTime} Min`;
                        if (data.remainingTime <= 0) {
                            alert("âŒ Your time has run out. Please purchase a new plan.");
                            window.location.href = "Buy.html"; // æ—¶é—´ä¸è¶³ï¼Œè·³è½¬åˆ°è´­ä¹°é¡µé¢
                        }
                    } else {
                        console.log("âŒ æ‰£è´¹å¤±è´¥:", data.message);
                    }
                })
                .catch(error => console.error("âŒ æ‰£è´¹è¯·æ±‚é”™è¯¯:", error));
        }
    </script>

</body>
</html>
